### Prompt 02: Crie a sua primeira proposta(proposal) de alteraÃ§Ã£o e validÃ¡-la

```bash
Atualize o arquivo openspec/project.md com as seguintes alteraÃ§Ãµes:

1. Adicione a tecnologia [TECNOLOGIA] na stack
2. Inclua a convenÃ§Ã£o de [CONVENÃ‡ÃƒO ESPECÃFICA]
3. Atualize a estrutura de pastas com [NOVA ESTRUTURA]

Mantenha as informaÃ§Ãµes existentes e adicione/modifique apenas o necessÃ¡rio.
```

Ex.:

````bash

Atualize o arquivo `openspec/project.md` com as seguintes alteraÃ§Ãµes:

1. Adicione a tecnologia **[TECNOLOGIA]** na stack.
2. Inclua a convenÃ§Ã£o **[CONVENÃ‡ÃƒO ESPECÃFICA]**.
3. Atualize a estrutura de pastas para o padrÃ£o **Arquitetura Hexagonal (Ports & Adapters)** conforme abaixo.

Mantenha todas as informaÃ§Ãµes existentes e altere apenas o necessÃ¡rio.

---

# ğŸ—‚ï¸ Estrutura de DiretÃ³rios â€” Arquitetura Hexagonal (Ports & Adapters)
```bash
src/
â”œâ”€â”€ core/                          # NÃºcleo da aplicaÃ§Ã£o (centro do hexÃ¡gono)
â”‚   â””â”€â”€ domain/
â”‚       â”œâ”€â”€ entities/              # Entidades de domÃ­nio
â”‚       â”‚   â””â”€â”€ User.js
â”‚       â”œâ”€â”€ value-objects/         # Objetos de valor
â”‚       â”‚   â””â”€â”€ Email.js
â”‚       â””â”€â”€ exceptions/            # ExceÃ§Ãµes de domÃ­nio
â”‚           â””â”€â”€ DomainException.js
â”‚
â”œâ”€â”€ application/                   # Casos de uso e portas
â”‚   â”œâ”€â”€ use-cases/                # OrquestraÃ§Ã£o da lÃ³gica
â”‚   â”‚   â”œâ”€â”€ CreateUserUseCase.js
â”‚   â”‚   â”œâ”€â”€ ListUsersUseCase.js
â”‚   â”‚   â”œâ”€â”€ GetUserByIdUseCase.js
â”‚   â”‚   â”œâ”€â”€ UpdateUserUseCase.js
â”‚   â”‚   â””â”€â”€ DeleteUserUseCase.js
â”‚   â””â”€â”€ ports/                    # Interfaces (contratos)
â”‚       â”œâ”€â”€ input/                # Portas de entrada (Primary Ports)
â”‚       â”‚   â”œâ”€â”€ CreateUserPort.js
â”‚       â”‚   â”œâ”€â”€ ListUsersPort.js
â”‚       â”‚   â”œâ”€â”€ GetUserByIdPort.js
â”‚       â”‚   â”œâ”€â”€ UpdateUserPort.js
â”‚       â”‚   â””â”€â”€ DeleteUserPort.js
â”‚       â””â”€â”€ output/               # Portas de saÃ­da (Secondary Ports)
â”‚           â”œâ”€â”€ UserRepositoryPort.js
â”‚           â””â”€â”€ EmailServicePort.js
â”‚
â”œâ”€â”€ adapters/                      # ImplementaÃ§Ãµes concretas
â”‚   â”œâ”€â”€ primary/                  # Adapters de entrada (Driving)
â”‚   â”‚   â””â”€â”€ http/
â”‚   â”‚       â”œâ”€â”€ controllers/
â”‚   â”‚       â”‚   â””â”€â”€ UserController.js
â”‚   â”‚       â”œâ”€â”€ routes/
â”‚   â”‚       â”‚   â””â”€â”€ userRoutes.js
â”‚   â”‚       â”œâ”€â”€ middlewares/
â”‚   â”‚       â”‚   â””â”€â”€ errorHandler.js
â”‚   â”‚       â””â”€â”€ dto/              # Data Transfer Objects
â”‚   â”‚           â”œâ”€â”€ CreateUserDTO.js
â”‚   â”‚           â””â”€â”€ UpdateUserDTO.js
â”‚   â”‚
â”‚   â””â”€â”€ secondary/                # Adapters de saÃ­da (Driven)
â”‚       â”œâ”€â”€ repositories/
â”‚       â”‚   â””â”€â”€ SqliteUserRepository.js
â”‚       â””â”€â”€ services/
â”‚           â””â”€â”€ NodemailerEmailService.js
â”‚
â”œâ”€â”€ shared/                        # CÃ³digo compartilhado
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ database.js
â”‚   â”œâ”€â”€ utils/
â”‚   â””â”€â”€ constants/
â”‚
â””â”€â”€ index.js                       # Entry point e DI setup
```

---

# ğŸ“ ConvenÃ§Ãµes de Nomenclatura OBRIGATÃ“RIAS (Hexagonal)

**Entidades:** `PascalCase`
* Ex.: `User.js`, `Product.js`

**Value Objects:** `PascalCase`
* Ex.: `Email.js`, `Money.js`

**Use Cases:** `PascalCase` + `UseCase`
* Ex.: `CreateUserUseCase.js`

**Ports (Input):** `PascalCase` + `Port`
* Ex.: `CreateUserPort.js`

**Ports (Output):** `PascalCase` + `Port`
* Ex.: `UserRepositoryPort.js`

**Adapters:** `PascalCase` + tipo do adapter
* Ex.: `SqliteUserRepository.js`, `NodemailerEmailService.js`

**Controllers:** `PascalCase` + `Controller`
* Ex.: `UserController.js`

**DTOs:** `PascalCase` + `DTO`
* Ex.: `CreateUserDTO.js`

**Routes:** `camelCase` + `Routes`
* Ex.: `userRoutes.js`

**VariÃ¡veis:** `camelCase`
* Ex.: `userName`, `userId`

**Constantes:** `SCREAMING_SNAKE_CASE`
* Ex.: `MAX_ATTEMPTS`, `DB_CONNECTION_STRING`

---

# ğŸ§  Camadas da Arquitetura Hexagonal

## 1. Core/Domain Layer (Centro do HexÃ¡gono)

**Local:** `src/core/domain/`

**Componentes:**
* Entidades de domÃ­nio
* Value Objects
* ExceÃ§Ãµes de domÃ­nio
* Regras de negÃ³cio puras

**Regras:**
* Zero dependÃªncias externas
* NÃ£o conhece frameworks
* NÃ£o conhece banco de dados
* NÃ£o conhece HTTP
* Apenas lÃ³gica de negÃ³cio pura

**Exemplo - Entidade:**
```javascript
// src/core/domain/entities/User.js
import Email from "../value-objects/Email.js"
import DomainException from "../exceptions/DomainException.js"

export default class User {
    constructor({ id = null, name, email, age } = {}) {
        this.id = id
        this.name = name
        this.email = new Email(email)
        this.age = age
    }

    validate() {
        if (!this.name || this.name.trim().length < 3) {
            throw new DomainException("Name must be at least 3 characters", 400)
        }

        if (!this.age || Number(this.age) < 18) {
            throw new DomainException("Age must be at least 18", 400)
        }

        this.email.validate()
    }

    toJSON() {
        return {
            id: this.id,
            name: this.name,
            email: this.email.value,
            age: this.age
        }
    }
}
```

**Exemplo - Value Object:**
```javascript
// src/core/domain/value-objects/Email.js
import DomainException from "../exceptions/DomainException.js"

export default class Email {
    constructor(value) {
        this.value = value
    }

    validate() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        if (!this.value || !emailRegex.test(this.value)) {
            throw new DomainException("Invalid email format", 400)
        }
    }

    equals(other) {
        return this.value === other.value
    }

    toString() {
        return this.value
    }
}
```

**Exemplo - Domain Exception:**
```javascript
// src/core/domain/exceptions/DomainException.js
export default class DomainException extends Error {
    constructor(message, statusCode = 400) {
        super(message)
        this.name = "DomainException"
        this.statusCode = statusCode
    }
}
```

---

## 2. Application Layer (Use Cases + Ports)

### 2.1 Input Ports (Primary Ports)

**Local:** `src/application/ports/input/`

**Componentes:**
* Interfaces que definem operaÃ§Ãµes da aplicaÃ§Ã£o
* Contratos para casos de uso

**Regras:**
* Apenas definem a interface (contrato)
* NÃ£o contÃ©m implementaÃ§Ã£o
* Usam JSDoc para documentaÃ§Ã£o de tipos

**Exemplo:**
```javascript
// src/application/ports/input/CreateUserPort.js
/**
 * @typedef {Object} CreateUserInput
 * @property {string} name
 * @property {string} email
 * @property {number} age
 */

/**
 * @typedef {Object} CreateUserOutput
 * @property {number} id
 * @property {string} name
 * @property {string} email
 * @property {number} age
 */

/**
 * Port para criaÃ§Ã£o de usuÃ¡rio
 */
export default class CreateUserPort {
    /**
     * @param {CreateUserInput} input
     * @returns {Promise<CreateUserOutput>}
     */
    async execute(input) {
        throw new Error("Method not implemented")
    }
}
```
```javascript
// src/application/ports/input/ListUsersPort.js
/**
 * Port para listagem de usuÃ¡rios
 */
export default class ListUsersPort {
    /**
     * @returns {Promise<Array>}
     */
    async execute() {
        throw new Error("Method not implemented")
    }
}
```
```javascript
// src/application/ports/input/GetUserByIdPort.js
/**
 * Port para buscar usuÃ¡rio por ID
 */
export default class GetUserByIdPort {
    /**
     * @param {number} id
     * @returns {Promise<Object>}
     */
    async execute(id) {
        throw new Error("Method not implemented")
    }
}
```

### 2.2 Output Ports (Secondary Ports)

**Local:** `src/application/ports/output/`

**Componentes:**
* Interfaces para persistÃªncia
* Interfaces para serviÃ§os externos
* Contratos de infraestrutura

**Regras:**
* Apenas definem a interface
* Implementadas pelos adapters secundÃ¡rios

**Exemplo:**
```javascript
// src/application/ports/output/UserRepositoryPort.js
/**
 * Port de repositÃ³rio de usuÃ¡rios
 */
export default class UserRepositoryPort {
    /**
     * @param {Object} user
     * @returns {Promise<Object>}
     */
    async save(user) {
        throw new Error("Method not implemented")
    }

    /**
     * @param {number} id
     * @returns {Promise<Object|null>}
     */
    async findById(id) {
        throw new Error("Method not implemented")
    }

    /**
     * @param {string} email
     * @returns {Promise<Object|null>}
     */
    async findByEmail(email) {
        throw new Error("Method not implemented")
    }

    /**
     * @returns {Promise<Array>}
     */
    async findAll() {
        throw new Error("Method not implemented")
    }

    /**
     * @param {number} id
     * @param {Object} data
     * @returns {Promise<Object>}
     */
    async update(id, data) {
        throw new Error("Method not implemented")
    }

    /**
     * @param {number} id
     * @returns {Promise<void>}
     */
    async delete(id) {
        throw new Error("Method not implemented")
    }
}
```
```javascript
// src/application/ports/output/EmailServicePort.js
/**
 * Port de serviÃ§o de email
 */
export default class EmailServicePort {
    /**
     * @param {string} to
     * @param {string} subject
     * @param {string} body
     * @returns {Promise<void>}
     */
    async send(to, subject, body) {
        throw new Error("Method not implemented")
    }
}
```

### 2.3 Use Cases

**Local:** `src/application/use-cases/`

**Componentes:**
* ImplementaÃ§Ã£o dos casos de uso
* OrquestraÃ§Ã£o da lÃ³gica de aplicaÃ§Ã£o

**Regras:**
* Implementam os Input Ports
* Dependem apenas de Output Ports (abstraÃ§Ãµes)
* NÃ£o conhecem detalhes de infraestrutura
* Coordenam entidades e serviÃ§os

**Exemplo - CreateUserUseCase:**
```javascript
// src/application/use-cases/CreateUserUseCase.js
import CreateUserPort from "../ports/input/CreateUserPort.js"
import User from "../../core/domain/entities/User.js"
import DomainException from "../../core/domain/exceptions/DomainException.js"

export default class CreateUserUseCase extends CreateUserPort {
    /**
     * @param {UserRepositoryPort} userRepository
     * @param {EmailServicePort} emailService
     */
    constructor(userRepository, emailService) {
        super()
        this.userRepository = userRepository
        this.emailService = emailService
    }

    async execute(input) {
        // Criar entidade de domÃ­nio
        const user = new User(input)
        user.validate()

        // Verificar duplicidade (regra de negÃ³cio)
        const existingUser = await this.userRepository.findByEmail(user.email.value)
        if (existingUser) {
            throw new DomainException("Email already registered", 409)
        }

        // Persistir
        const savedUser = await this.userRepository.save(user.toJSON())

        // Enviar email de boas-vindas (opcional)
        await this.emailService.send(
            savedUser.email,
            "Welcome!",
            `Hello ${savedUser.name}, welcome to our platform!`
        )

        return savedUser
    }
}
```

**Exemplo - ListUsersUseCase:**
```javascript
// src/application/use-cases/ListUsersUseCase.js
import ListUsersPort from "../ports/input/ListUsersPort.js"

export default class ListUsersUseCase extends ListUsersPort {
    /**
     * @param {UserRepositoryPort} userRepository
     */
    constructor(userRepository) {
        super()
        this.userRepository = userRepository
    }

    async execute() {
        return this.userRepository.findAll()
    }
}
```

**Exemplo - GetUserByIdUseCase:**
```javascript
// src/application/use-cases/GetUserByIdUseCase.js
import GetUserByIdPort from "../ports/input/GetUserByIdPort.js"
import DomainException from "../../core/domain/exceptions/DomainException.js"

export default class GetUserByIdUseCase extends GetUserByIdPort {
    /**
     * @param {UserRepositoryPort} userRepository
     */
    constructor(userRepository) {
        super()
        this.userRepository = userRepository
    }

    async execute(id) {
        const user = await this.userRepository.findById(id)

        if (!user) {
            throw new DomainException("User not found", 404)
        }

        return user
    }
}
```

**Exemplo - UpdateUserUseCase:**
```javascript
// src/application/use-cases/UpdateUserUseCase.js
import UpdateUserPort from "../ports/input/UpdateUserPort.js"
import User from "../../core/domain/entities/User.js"
import DomainException from "../../core/domain/exceptions/DomainException.js"

export default class UpdateUserUseCase extends UpdateUserPort {
    /**
     * @param {UserRepositoryPort} userRepository
     */
    constructor(userRepository) {
        super()
        this.userRepository = userRepository
    }

    async execute(id, input) {
        // Verificar se existe
        const existing = await this.userRepository.findById(id)
        if (!existing) {
            throw new DomainException("User not found", 404)
        }

        // Validar novos dados
        const user = new User({ ...input, id })
        user.validate()

        // Atualizar
        return this.userRepository.update(id, user.toJSON())
    }
}
```

**Exemplo - DeleteUserUseCase:**
```javascript
// src/application/use-cases/DeleteUserUseCase.js
import DeleteUserPort from "../ports/input/DeleteUserPort.js"
import DomainException from "../../core/domain/exceptions/DomainException.js"

export default class DeleteUserUseCase extends DeleteUserPort {
    /**
     * @param {UserRepositoryPort} userRepository
     */
    constructor(userRepository) {
        super()
        this.userRepository = userRepository
    }

    async execute(id) {
        const existing = await this.userRepository.findById(id)
        if (!existing) {
            throw new DomainException("User not found", 404)
        }

        await this.userRepository.delete(id)
    }
}
```

---

## 3. Primary Adapters (Driving/Entrada)

**Local:** `src/adapters/primary/`

**Componentes:**
* Controllers HTTP
* Rotas
* DTOs
* Middlewares

**Regras:**
* Convertem requisiÃ§Ãµes externas em chamadas de use cases
* Dependem apenas de Input Ports
* Tratam dados de entrada/saÃ­da (serializaÃ§Ã£o)

**Exemplo - DTO:**
```javascript
// src/adapters/primary/http/dto/CreateUserDTO.js
export default class CreateUserDTO {
    static fromRequest(body) {
        return {
            name: body.name,
            email: body.email,
            age: Number(body.age)
        }
    }

    static toResponse(user) {
        return {
            id: user.id,
            name: user.name,
            email: user.email,
            age: user.age
        }
    }
}
```

**Exemplo - Controller:**
```javascript
// src/adapters/primary/http/controllers/UserController.js
import CreateUserDTO from "../dto/CreateUserDTO.js"

export default class UserController {
    /**
     * @param {CreateUserPort} createUserUseCase
     * @param {ListUsersPort} listUsersUseCase
     * @param {GetUserByIdPort} getUserByIdUseCase
     * @param {UpdateUserPort} updateUserUseCase
     * @param {DeleteUserPort} deleteUserUseCase
     */
    constructor(
        createUserUseCase,
        listUsersUseCase,
        getUserByIdUseCase,
        updateUserUseCase,
        deleteUserUseCase
    ) {
        this.createUserUseCase = createUserUseCase
        this.listUsersUseCase = listUsersUseCase
        this.getUserByIdUseCase = getUserByIdUseCase
        this.updateUserUseCase = updateUserUseCase
        this.deleteUserUseCase = deleteUserUseCase
    }

    async index(req, res, next) {
        try {
            const users = await this.listUsersUseCase.execute()
            res.json({ success: true, data: users })
        } catch (err) {
            next(err)
        }
    }

    async show(req, res, next) {
        try {
            const user = await this.getUserByIdUseCase.execute(Number(req.params.id))
            res.json({ success: true, data: user })
        } catch (err) {
            next(err)
        }
    }

    async store(req, res, next) {
        try {
            const input = CreateUserDTO.fromRequest(req.body)
            const user = await this.createUserUseCase.execute(input)
            const response = CreateUserDTO.toResponse(user)
            res.status(201).json({ success: true, data: response })
        } catch (err) {
            next(err)
        }
    }

    async update(req, res, next) {
        try {
            const id = Number(req.params.id)
            const input = CreateUserDTO.fromRequest(req.body)
            const user = await this.updateUserUseCase.execute(id, input)
            const response = CreateUserDTO.toResponse(user)
            res.json({ success: true, data: response })
        } catch (err) {
            next(err)
        }
    }

    async destroy(req, res, next) {
        try {
            await this.deleteUserUseCase.execute(Number(req.params.id))
            res.status(204).send()
        } catch (err) {
            next(err)
        }
    }
}
```

**Exemplo - Routes:**
```javascript
// src/adapters/primary/http/routes/userRoutes.js
import { Router } from "express"

export default function createUserRoutes(userController) {
    const router = Router()

    router.get("/users", (req, res, next) => userController.index(req, res, next))
    router.get("/users/:id", (req, res, next) => userController.show(req, res, next))
    router.post("/users", (req, res, next) => userController.store(req, res, next))
    router.put("/users/:id", (req, res, next) => userController.update(req, res, next))
    router.delete("/users/:id", (req, res, next) => userController.destroy(req, res, next))

    return router
}
```

**Exemplo - Error Handler:**
```javascript
// src/adapters/primary/http/middlewares/errorHandler.js
import DomainException from "../../../../core/domain/exceptions/DomainException.js"

export default function errorHandler(err, req, res, next) {
    console.error(err.stack)

    if (err instanceof DomainException) {
        return res.status(err.statusCode).json({
            success: false,
            message: err.message
        })
    }

    res.status(500).json({
        success: false,
        message: err.message || "Internal Server Error",
        ...(process.env.NODE_ENV === "development" && { stack: err.stack })
    })
}
```

---

## 4. Secondary Adapters (Driven/SaÃ­da)

**Local:** `src/adapters/secondary/`

**Componentes:**
* ImplementaÃ§Ãµes de repositÃ³rios
* ImplementaÃ§Ãµes de serviÃ§os externos
* Adapters de banco de dados

**Regras:**
* Implementam Output Ports
* ContÃ©m detalhes de infraestrutura
* SQL/Queries permitidos apenas aqui
* Chamadas a APIs externas

**Exemplo - Repository:**
```javascript
// src/adapters/secondary/repositories/SqliteUserRepository.js
import UserRepositoryPort from "../../../application/ports/output/UserRepositoryPort.js"
import db from "../../../shared/config/database.js"

export default class SqliteUserRepository extends UserRepositoryPort {
    async save(user) {
        const { name, email, age } = user
        const result = await db.run(
            "INSERT INTO users (name, email, age) VALUES (?, ?, ?)",
            [name, email, age]
        )
        return { id: result.lastID, name, email, age }
    }

    async findById(id) {
        return db.get(
            "SELECT id, name, email, age FROM users WHERE id = ?",
            [id]
        )
    }

    async findByEmail(email) {
        return db.get(
            "SELECT id, name, email, age FROM users WHERE email = ?",
            [email]
        )
    }

    async findAll() {
        return db.all("SELECT id, name, email, age FROM users")
    }

    async update(id, data) {
        const { name, email, age } = data
        await db.run(
            "UPDATE users SET name = ?, email = ?, age = ? WHERE id = ?",
            [name, email, age, id]
        )
        return this.findById(id)
    }

    async delete(id) {
        await db.run("DELETE FROM users WHERE id = ?", [id])
    }
}
```

**Exemplo - External Service:**
```javascript
// src/adapters/secondary/services/NodemailerEmailService.js
import EmailServicePort from "../../../application/ports/output/EmailServicePort.js"
import nodemailer from "nodemailer"

export default class NodemailerEmailService extends EmailServicePort {
    constructor() {
        super()
        this.transporter = nodemailer.createTransport({
            host: process.env.SMTP_HOST,
            port: process.env.SMTP_PORT,
            auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS
            }
        })
    }

    async send(to, subject, body) {
        try {
            await this.transporter.sendMail({
                from: process.env.SMTP_FROM,
                to,
                subject,
                text: body
            })
        } catch (error) {
            console.error("Email sending failed:", error)
            // NÃ£o falhar a operaÃ§Ã£o principal se email falhar
        }
    }
}
```

---

## 5. Shared Layer

**Local:** `src/shared/`

**Exemplo - Database Config:**
```javascript
// src/shared/config/database.js
import sqlite3 from "sqlite3"
import { open } from "sqlite"
import path from "path"
import { fileURLToPath } from "url"

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const DB_PATH = process.env.DB_PATH || path.join(__dirname, "../../database.sqlite")

let db = null

async function getDatabase() {
    if (db) return db

    db = await open({
        filename: DB_PATH,
        driver: sqlite3.Database
    })

    await db.exec("PRAGMA foreign_keys = ON")

    // Criar tabelas se nÃ£o existirem
    await db.exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE NOT NULL,
            age INTEGER NOT NULL
        )
    `)

    return db
}

export default await getDatabase()
```

---

## 6. Entry Point & Dependency Injection

**Local:** `src/index.js`

**Componentes:**
* ConfiguraÃ§Ã£o de DI (Dependency Injection)
* InicializaÃ§Ã£o da aplicaÃ§Ã£o
* Wiring de dependÃªncias

**Exemplo:**
```javascript
// src/index.js
import express from "express"

// Use Cases
import CreateUserUseCase from "./application/use-cases/CreateUserUseCase.js"
import ListUsersUseCase from "./application/use-cases/ListUsersUseCase.js"
import GetUserByIdUseCase from "./application/use-cases/GetUserByIdUseCase.js"
import UpdateUserUseCase from "./application/use-cases/UpdateUserUseCase.js"
import DeleteUserUseCase from "./application/use-cases/DeleteUserUseCase.js"

// Secondary Adapters (Output)
import SqliteUserRepository from "./adapters/secondary/repositories/SqliteUserRepository.js"
import NodemailerEmailService from "./adapters/secondary/services/NodemailerEmailService.js"

// Primary Adapters (Input)
import UserController from "./adapters/primary/http/controllers/UserController.js"
import createUserRoutes from "./adapters/primary/http/routes/userRoutes.js"
import errorHandler from "./adapters/primary/http/middlewares/errorHandler.js"

const app = express()
const PORT = process.env.PORT || 3000

app.use(express.json())

// ============================================
// DEPENDENCY INJECTION (Manual Wiring)
// ============================================

// Instanciar adapters secundÃ¡rios (implementaÃ§Ãµes de Output Ports)
const userRepository = new SqliteUserRepository()
const emailService = new NodemailerEmailService()

// Instanciar use cases (injetando dependÃªncias)
const createUserUseCase = new CreateUserUseCase(userRepository, emailService)
const listUsersUseCase = new ListUsersUseCase(userRepository)
const getUserByIdUseCase = new GetUserByIdUseCase(userRepository)
const updateUserUseCase = new UpdateUserUseCase(userRepository)
const deleteUserUseCase = new DeleteUserUseCase(userRepository)

// Instanciar controller (injetando use cases)
const userController = new UserController(
    createUserUseCase,
    listUsersUseCase,
    getUserByIdUseCase,
    updateUserUseCase,
    deleteUserUseCase
)

// Criar rotas (injetando controller)
const userRoutes = createUserRoutes(userController)

// ============================================
// CONFIGURAR ROTAS
// ============================================

app.use("/api", userRoutes)

// Middleware final de erro
app.use(errorHandler)

// ============================================
// INICIAR SERVIDOR
// ============================================

app.listen(PORT, () => {
    console.log(`ğŸš€ Server running on port ${PORT}`)
    console.log(`ğŸ“ Architecture: Hexagonal (Ports & Adapters)`)
})

export default app
```

---

# ğŸ”€ Fluxo de DependÃªncias na Arquitetura Hexagonal
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRIMARY ADAPTERS                          â”‚
â”‚                   (HTTP, CLI, GraphQL)                       â”‚
â”‚                          â†“                                   â”‚
â”‚                    Input Ports                               â”‚
â”‚                  (Interfaces/Contratos)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION                               â”‚
â”‚                     (Use Cases)                              â”‚
â”‚                          â†“                                   â”‚
â”‚                    Output Ports                              â”‚
â”‚                  (Interfaces/Contratos)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SECONDARY ADAPTERS                         â”‚
â”‚              (Database, External APIs, Email)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CORE/DOMAIN                               â”‚
â”‚            (Entities, Value Objects, Rules)                  â”‚
â”‚              (Usado por todas as camadas)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PrincÃ­pio chave:** As dependÃªncias sempre apontam para dentro (em direÃ§Ã£o ao core/domain)

---

# ğŸ“‘ PadrÃ£o de Respostas HTTP

**Sucesso (item Ãºnico):**
```json
{
    "success": true,
    "data": { "id": 1, "name": "JoÃ£o", "email": "joao@example.com", "age": 25 }
}
```

**Sucesso (lista):**
```json
{
    "success": true,
    "data": [
        { "id": 1, "name": "JoÃ£o", "email": "joao@example.com", "age": 25 },
        { "id": 2, "name": "Maria", "email": "maria@example.com", "age": 30 }
    ]
}
```

**Erro (Domain Exception):**
```json
{
    "success": false,
    "message": "Email already registered"
}
```

**Erro (GenÃ©rico):**
```json
{
    "success": false,
    "message": "Internal Server Error"
}
```

---

# âœ… Checklist da Arquitetura Hexagonal

- [ ] **Core isolado** - DomÃ­nio sem dependÃªncias externas
- [ ] **Ports definidos** - Input e Output Ports como interfaces
- [ ] **Use Cases puros** - Dependem apenas de abstraÃ§Ãµes (Ports)
- [ ] **Primary Adapters** - Controllers/HTTP dependem de Input Ports
- [ ] **Secondary Adapters** - RepositÃ³rios implementam Output Ports
- [ ] **InjeÃ§Ã£o de DependÃªncia** - DI manual ou com container
- [ ] **Fluxo correto** - DependÃªncias apontam para o core
- [ ] **DTOs** - ConversÃ£o de dados na camada de adapters
- [ ] **Value Objects** - Objetos imutÃ¡veis com validaÃ§Ã£o
- [ ] **Domain Exceptions** - ExceÃ§Ãµes especÃ­ficas do domÃ­nio
- [ ] **Sem vazamento** - Frameworks nÃ£o vazam para o core
- [ ] **Testabilidade** - Use Cases testÃ¡veis com mocks de Ports

---

# ğŸ¯ PrincÃ­pios Fundamentais

1. **Dependency Inversion Principle (DIP)**
   - Use Cases dependem de abstraÃ§Ãµes (Ports), nÃ£o de implementaÃ§Ãµes
   - Adapters implementam os Ports

2. **Separation of Concerns**
   - Core/Domain: Regras de negÃ³cio puras
   - Application: OrquestraÃ§Ã£o (Use Cases)
   - Adapters: Detalhes tÃ©cnicos

3. **Testability**
   - Core e Use Cases sÃ£o facilmente testÃ¡veis
   - Mocks implementam Output Ports para testes

4. **Technology Agnostic Core**
   - Core nÃ£o conhece Express, SQLite, etc.
   - FÃ¡cil trocar tecnologias (ex: SQLite â†’ PostgreSQL)

---

# ğŸ§ª Exemplo de Teste (Use Case)
```javascript
// src/application/use-cases/__tests__/CreateUserUseCase.test.js
import CreateUserUseCase from "../CreateUserUseCase.js"
import UserRepositoryPort from "../../ports/output/UserRepositoryPort.js"
import EmailServicePort from "../../ports/output/EmailServicePort.js"
import DomainException from "../../../core/domain/exceptions/DomainException.js"

// Mock do Repository (implementa o Port)
class MockUserRepository extends UserRepositoryPort {
    constructor() {
        super()
        this.users = []
    }

    async save(user) {
        const saved = { ...user, id: this.users.length + 1 }
        this.users.push(saved)
        return saved
    }

    async findByEmail(email) {
        return this.users.find(u => u.email === email) || null
    }
}

// Mock do Email Service
class MockEmailService extends EmailServicePort {
    constructor() {
        super()
        this.sentEmails = []
    }

    async send(to, subject, body) {
        this.sentEmails.push({ to, subject, body })
    }
}

describe("CreateUserUseCase", () => {
    let useCase
    let userRepository
    let emailService

    beforeEach(() => {
        userRepository = new MockUserRepository()
        emailService = new MockEmailService()
        useCase = new CreateUserUseCase(userRepository, emailService)
    })

    test("should create user successfully", async () => {
        const input = {
            name: "JoÃ£o Silva",
            email: "joao@example.com",
            age: 25
        }

        const result = await useCase.execute(input)

        expect(result).toHaveProperty("id")
        expect(result.name).toBe("JoÃ£o Silva")
        expect(emailService.sentEmails).toHaveLength(1)
    })

    test("should throw error for duplicate email", async () => {
        const input = {
            name: "JoÃ£o Silva",
            email: "joao@example.com",
            age: 25
        }

        await useCase.execute(input)

        await expect(useCase.execute(input)).rejects.toThrow(DomainException)
        await expect(useCase.execute(input)).rejects.toThrow("Email already registered")
    })

    test("should throw error for invalid email", async () => {
        const input = {
            name: "JoÃ£o Silva",
            email: "invalid-email",
            age: 25
        }

        await expect(useCase.execute(input)).rejects.toThrow("Invalid email format")
    })

    test("should throw error for age < 18", async () => {
        const input = {
            name: "JoÃ£o Silva",
            email: "joao@example.com",
            age: 16
        }

        await expect(useCase.execute(input)).rejects.toThrow("Age must be at least 18")
    })
})
```

---

# ğŸ“š Vantagens da Arquitetura Hexagonal

âœ… **Testabilidade Superior** - Core e Use Cases facilmente testÃ¡veis sem infraestrutura
âœ… **IndependÃªncia de Framework** - FÃ¡cil trocar Express por Fastify, etc.
âœ… **IndependÃªncia de Banco** - FÃ¡cil migrar SQLite â†’ PostgreSQL â†’ MongoDB
âœ… **Manutenibilidade** - SeparaÃ§Ã£o clara de responsabilidades
âœ… **Flexibilidade** - MÃºltiplos adapters (HTTP, CLI, GraphQL) compartilham mesmos Use Cases
âœ… **Regras de NegÃ³cio Protegidas** - Core isolado de detalhes tÃ©cnicos

---



```

---


```

Depois que a IA criar/atualizar o arquivo, vocÃª revisa e pede ajustes:

```bash
Revise o openspec/project.md e ajuste:
- Adicione mais detalhes sobre [ASPECTO ESPECÃFICO]
- Corrija a descriÃ§Ã£o de [ITEM]
- Remova [INFORMAÃ‡ÃƒO DESNECESSÃRIA]
```

```

**Valide:** Ã© importante vocÃª validar para seguir para o prÃ³ximo passo.

```bash
openspec validate [change-id] --strict
```

Ex.:

```bash
openspec validate [add-user-registration] --strict
```
````
